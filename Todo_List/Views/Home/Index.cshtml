<div class="modal fade" id="deleteEntityModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="deleteEntityModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 550px; min-width: 307px; width:fit-content;">
        <div class="modal-content">
            <div class="modal-body">
                <span class="form-subtitle" id="modal-content-text"></span>
            </div>
            <div class="modal-footer">
                <button class="violet-button" id="confirmDelete" type="button" style="height:40px; background-color: #c95252;">Usuń kontakt</button>
                <button class="violet-button" id="denyDelete" type="button" style="margin-left:10px; height:40px;">Anuluj</button>
            </div>
        </div>
    </div>
</div>

<div class="content-container">
    <div class="tab-content" id="category-tab-content">
        <div class="tab-pane show active" id="today" aria-labelledby="today-tab">
            <div class="today-container list-container">
                <div class="options-header">
                </div>
                <div class="list-header">
                    <div class="list-header-left">
                        <button class="add-new-button violet-button" type="button" onclick="openCreateTaskWindow()">Dodaj nowe</button>
                    </div>
                    <div class="search-for-todays-task">
                        <input class="search-for todays-task-search" placeholder="Wyszukaj zadanie" />
                    </div>
                </div>
                <div class="list-content">
                    <div class="table-responsive">
                        <table class="table table-borderless" id="todays-tasks-table">
                            <thead>
                                <tr>
                                    <th scope="col"></th>
                                    <th scope="col">Nazwa</th>
                                    <th scope="col">Do kiedy</th>
                                    <th scope="col">Priorytet</th>
                                    <th scope="col">Przypomnienie</th>
                                    <th class="centered-cell" scope="col" style="min-width: 175px;">Opcje</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="add-new-task options-container" style="display:none;">
                <div class="option-content">
                    <div class="options-header">
                        <div class="previous-page" style="flex:1;">
                            <button class="violet-button" type="button" style="display: flex; align-items:center;" onclick="goBackToTodaysList()">
                                <span class="arrow-back" style="max-width:24px;"><img src="~/icons/previous.png" /></span>
                                <span>Powrót</span>
                            </button>
                        </div>
                        <div class="option-name" style="flex:auto; text-align:center;">
                            <span class="opion-name-placeholder" id="todays-input-window-title">Nowe zadanie</span>
                        </div>
                        <div style="flex:1;"></div>
                    </div>
                    <hr />
                    <form class="options-form todays-options-form" id="add-edit-todays-task-form">
                        <div class="basic-data">
                            <span class="form-subtitle">Podstawowe dane</span>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col">
                                        <label for="todays-task-name">Nazwa zadania *</label>
                                        <input type="text" class="form-input" id="todays-task-name" required maxlength="30" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <label for="todays-task-priority">Priorytet</label>
                                        <select class="task-priority" id="todays-task-priority">
                                            <option value="-1" selected>Brak priorytetu</option>
                                            <option value="0" >Niski</option>
                                            <option value="1" >Średni</option>
                                            <option value="2" >Wysoki</option>
                                            <option value="3" >Najwyższy</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <label for="todays-task-notes">Notatki</label>
                                        <textarea class="form-input" id="todays-task-notes" rows="3" maxlength="120" spellcheck="false"></textarea>
                                        <div class="symbol-counter" style="margin-top: 0.25rem; text-align: right" id="symbolCounterAdd">&nbsp</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr />
                        <div class="timeframes">
                            <span class="form-subtitle">Ramy czasowe</span>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col">
                                        <label for="todays-start-date">Data zakończenia</label>
                                        <input type="datetime-local" class="datetime-input" id="todays-start-date" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr />
                        <div class="recurrence">
                            <span class="form-subtitle">Powtarzalność zadania</span>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col">
                                        <label for="todays-recurrence-unit">Jednostka czasu</label>
                                        <select class="recurrence-unit" id="todays-recurrence-unit" disabled>
                                            <option value="-1" selected>Nie powtarzaj</option>
                                            <option value="0">Dni</option>
                                            <option value="1">Tygodnie</option>
                                            <option value="2">Miesiące</option>
                                            <option value="3">Lata</option>
                                        </select>
                                    </div>
                                    <div class="col">
                                        <label for="todays-recurrence-interval">Interwał czasu</label>
                                        <input type="text" class="form-input" id="todays-recurrence-interval" disabled/>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <label for="todays-reccur-start">Powtarzaj od</label>
                                        <input type="date" class="datetime-input" id="todays-reccur-start" disabled />
                                    </div>
                                    <div class="col">
                                        <label for="todays-reccur-until">Powtarzaj do</label>
                                        <input type="date" class="datetime-input" id="todays-reccur-until" disabled/>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr />
                        <div class="reminder" style="margin-bottom:20px">
                            <span class="form-subtitle">Przypomnienie</span>
                            <div class="form-group">
                                <div class="row">
                                    <div class="col">
                                        <label for="todays-reminder-unit">Data przypomnienia</label>
                                        <input type="datetime-local" class="datetime-input" id="todays-reminder-date" disabled />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="justify-content-center d-flex">
                            <button type="submit" class="violet-button" id="createOrEditTodaysButton"></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="tab-pane" id="calendar" aria-labelledby="calendar-tab">
        </div>
    </div>
</div>

<script>
    function openCreateTaskWindow(){
        $(".today-container").hide();
        $(".add-new-task").show();
        $("#createOrEditTodaysButton").html("Utwórz zadanie")
    }

    function addTaskToTable(task, tableId) {
        var dueTimeParsed = new Date(task.dueDate);
        var currentDate = new Date();

        const isCompleted = (currentDate > dueTimeParsed)
            ? (task.isCompleted) ? `
            <div class="round">
                <input class="complete-task-checkbox" type="Checkbox" id="checkbox-${task.id}" checked disabled/>
                <label for="checkbox-${task.id}"></label>
            <div>`
            : `
            <div class="round-red">
                <input class="failed-task-checkbox" type="Checkbox" id="checkbox-${task.id}" checked disabled/>
                <label for="checkbox-${task.id}"></label>
            <div>`
            : (task.isCompleted) ? `
            <div class="round">
                <input class="complete-task-checkbox" type="Checkbox" id="checkbox-${task.id}" checked disabled/>
                <label for="checkbox-${task.id}"></label>
            <div>`
            : `
            <div class="round">
                <input class="complete-task-checkbox" type="Checkbox" id="checkbox-${task.id}"/>
                <label for="checkbox-${task.id}"></label>
            <div>
            `

        const reminder = (currentDate > dueTimeParsed)
            ? (task.reminderSet ? "Przypomniano" : "Nie ustawiono")
            : (task.reminderSet ? "Ustawiono" : "Nie ustawiono");

        const options = (currentDate > dueTimeParsed)
            ? (task.isCompleted) ? `
            <td class="centered-cell">
                <a href="#details-${task.id}" class="icon-list todays-details"><img src="/icons/view-doc.png" title="Szczegóły"/></a>
            </td>
            `
            : `
            <td class="centered-cell">
                <a href="#details-${task.id}" class="icon-list todays-details"><img src="/icons/view-doc.png" title="Szczegóły"/></a>
                <a href="#postpone-${task.id}" class="icon-list todays-postpone"><img src="/icons/postpone.png" title="Przełóż na jutro"/></a>
            </td>`
            : (task.isCompleted) ? `
            <td class="centered-cell">
                <a href="#details-${task.id}" class="icon-list todays-details"><img src="/icons/view-doc.png" title="Szczegóły"/></a>
            </td>
            `
            : `
            <td class="centered-cell">
                <a href="#details-${task.id}" class="icon-list todays-details"><img src="/icons/view-doc.png" title="Szczegóły"/></a>
                <a href="#edit-${task.id}" class="icon-list todays-edit"><img src="/icons/edit.png" title="Edytuj"/></a>
                <a href="#delete-${task.id}" class="icon-list todays-delete"><img src="/icons/trash.png" title="Usuń"/></a>
            </td>
            `


        var newRow = `
            <tr>
                <td>
                    ${isCompleted}
                </td>
                <td class="task-name">${task.name}</td>
                <td>${new Date(task.dueDate).toLocaleString('pl-PL').split(",")[1]}</td>
                <td>${task.priority == null ? "Brak" : task.priority}</td>
                <td>${reminder}</td>
                ${options}
            </tr>
        `;

        $(`#${tableId} tbody`).append(newRow);
    }

    function OnInputFilterTable(searchBarIdentification, tableIdentification) {
        $(searchBarIdentification).on('input', function () {

            var filterText = $(this).val().toLowerCase();

            $(`${tableIdentification} tbody tr`).each(function () {
                var rowHit = false;
                $(this).find('td').each(function () {
                    if ($(this).text().toLowerCase().includes(filterText)) {
                        rowHit = true;
                        return false;
                    }
                });

                $(this).toggle(rowHit);
            });
        });
    }

    function goBackToTodaysList(){
        $(".todays-options-form :input[type='text']").val('');
        $(".todays-options-form :input[type='datetime-local']").val('');
        $(".todays-options-form :input[type='date']").val('');
        $(".todays-options-form :input[type='number']").val('');
        $(".todays-options-form textarea").val('');
        $(".todays-options-form select").prop('selectedIndex', 0);
        $("#todays-recurrence-interval").prop('disabled', true);
        $("#todays-reminder-date").prop("disabled", true);
        $("#createOrEditTodaysButton").html("");

        $(".add-new-task").hide();
        $(".today-container").show();
    }

    function deleteTask(taskId){
        $.ajax({
            url: '@Url.Action("DeleteTask", "Endpoints")',
            type: 'GET',
            data: {taskId},
            contentType: 'application/json',
            success: function () {

            },
            error: function (error) {
                console.error(error.responseText);
            }
        })
    }

    function getTodaysTasks(){
        $.ajax({
            url: '@Url.Action("GetTodaysTasks", "Endpoints")',
            type: 'GET',
            contentType: 'application/json',
            success: function (listOfTasks) {
                if(listOfTasks.length == 0 || listOfTasks.length == undefined){
                    console.log("No tasks found")
                    return;
                }
                listOfTasks.forEach(task => {
                    addTaskToTable(task, "todays-tasks-table");
                    
                });
            },
            error: function (error) {
                console.error(error.responseText);
            }
        });
    }

    function addNewTask(){
        var name = $("#todays-task-name").val();
        var priority = $("#todays-task-priority").val();
        var notes = $("#todays-task-notes").val();
        var dueDate = $("#todays-start-date").val();
        var recurrenceUnit = $("#todays-recurrence-unit").val();
        var recurrenceInterval = $("#todays-recurrence-interval").val();
        var recurStart = $("#todays-reccur-start").val();
        var recurUntil = $("#todays-reccur-until").val();
        var reminderDate = $("#todays-reminder-date").val();

        $.ajax({
            url: '@Url.Action("CreateNewTask", "Endpoints")',
            type: 'GET',
            contentType: 'application/json',
            data: { taskName: name, taskPriority: priority, taskNotes: notes, taskDueDate: dueDate, taskRecurrenceUnit: recurrenceUnit, taskRecurrenceInterval: recurrenceInterval, taskRecurStart: recurStart, taskRecurUntil: recurUntil, taskReminderDate: reminderDate },
            success: function (task) {
                if(task.dueDate != null){
                    var dueDateParsed = new Date(task.dueDate);
                    addTaskToTable(task, "todays-tasks-table");
                }
            },
            error: function (error){
                console.error(error.responseText);
            }
        });
    }

    $(document).ready(function () {

        getTodaysTasks();

        $(document).on('submit', '#add-edit-todays-task-form', function (e) {
            e.preventDefault();
            addNewTask();
            goBackToTodaysList();
        });

        $(document).on('hidden.bs.modal', '#viewReportModal', function () {
            $('#confirmDelete').off('click');s
            $('#denyDelete').off('click');
        });


        $("#todays-start-date").change(function() {
            if ($("#todays-start-date").val() == ""){
                $("#todays-reminder-date").val("").prop("disabled", true);
                $("#todays-recurrence-interval").val("").prop('disabled', true);
                $("#todays-recurrence-unit").prop('selectedIndex', 0);
                $("#todays-recurrence-unit").val("").prop("disabled", true);
                $("#todays-reccur-start").val("").prop('disabled', true);
                $("#todays-reccur-until").val("").prop('disabled', true);
            }
            else{
                $("#todays-reminder-date").prop("disabled", false).prop('max', `${$("#todays-start-date").val()}`);
                $("#todays-recurrence-unit").prop("disabled", false);
                $("#todays-reccur-start").prop('min', `${$("#todays-start-date").val().split('T')[0]}`);
            }
        });
        $("#todays-recurrence-unit").change(function() {
            if ($("#todays-recurrence-unit").val() == -1){
                $("#todays-recurrence-interval").prop('disabled', true);
                $("#todays-reccur-start").val("").prop('disabled', true);
                $("#todays-reccur-until").val("").prop('disabled', true);
            }
            else{
                $("#todays-recurrence-interval").prop('disabled', false);
            }
            
        });

        $("#todays-recurrence-interval").change(function () {
            if ($("#todays-recurrence-interval").val() == ""){
                $("#todays-reccur-start").val("").prop('disabled', true);
                $("#todays-reccur-until").val("").prop('disabled', true);
            }
            else{
                $("#todays-reccur-start").prop('disabled', false);
            }
            
        })
        $("#todays-reccur-start").change(function () {
            if ($("#todays-reccur-start").val() == "") {
                $("#todays-reccur-until").val("").prop('disabled', true);
            }
            else{
                $("#todays-reccur-until").prop('disabled', false).prop('min', `${$("#todays-reccur-start").val().split('T')[0]}`);;
            }
        });

        $(document).on('click', ".todays-delete", function (e) {
            e.preventDefault();
            var id = $(this).attr('href').split('-')[1];
            var thisElement = $(this);

            var name = $(this).closest('tr').find('.task-name').text()

            $("#modal-content-text").html(`Czy na pewno chcesz usunąć zadanie ${name}?`);
            $("#confirmDelete").html("Usuń zadanie");

            $('#deleteEntityModal').modal("show");

            $('#confirmDelete').on('click', function () {
                deleteTask(id);
                thisElement.closest('tr').remove();
                
                $('#deleteEntityModal').modal("hide");
            });

            $('#denyDelete').on('click', function () {

                $('#deleteEntityModal').modal("hide");
            });
        });


        OnInputFilterTable(".todays-task-search", "#todays-tasks-table");

    });


</script>

